# Wedding Invitation API SERVER

## 1. Requirements

- ì‚¬ì§„ API
  - [ ] TOP ì‚¬ì§„ ì¡°íšŒ, ìˆ˜ì • API
    - [ ] ìˆ˜ì • APIëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥
  - [ ] ì‚¬ì§„ ì¡°íšŒ, ìˆ˜ì • API
    - [ ] ìˆ˜ì • APIëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥
- ì¶•í•˜ê¸€ API
  - [ ] ì¶•í•˜ê¸€ ì¡°íšŒ no-offset, ìˆ˜ì • API
    - [ ] ìˆ˜ì • APIëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥

## 2. Environment

### 1) ê°œë°œ í™˜ê²½
- ê¸°ë³¸ ì‚¬ìš© í¬íŠ¸ : 8080
- ì½”ë“œì»¨ë²¤ì…˜ : chang_sol_code_style.xml ì°¸ê³ 
- JAVA 16
- SpringBoot 2.7.14
- JPA (Spring Data JPA)
- DB:MS-SQL 2019 (module-infra yml ì°¸ê³ )

```yaml
  h2:
    console:
      enabled: true  # H2 console ì‚¬ìš©
      path: /h2  # console ê²½ë¡œ

  #DBì„¤ì •
  datasource:
    #h2 ë“œë¼ì´ë²„ ì„¤ì •
    driver-class-name: org.h2.Driver
    #ì‚¬ìš©í•  DB URL (Connection)
    url: jdbc:h2:mem:blog_search
    username: changsol  #ID
    password: changsol^_^3  #PWD
```

- SpringDocë¥¼ í†µí•œ OpenAPI(3.0) swagger 

```yaml
#SrpingDoc ì„¤ì • API ë¬¸ì„œí™”
springdoc:
  version: 0.0.1
  api-docs:
    path: /api-docs
  #Media Type ê¸°ë³¸ ê°’ì„ application/json
  default-consumes-media-type: application/json;charset=UTF-8
  default-produces-media-type: application/json;charset=UTF-8
  cache:
    disabled: true
  swagger-ui:
    #api ë° íƒœê·¸ ì •ë ¬ ê¸°ì¤€ì„ ì•ŒíŒŒë²³ ì˜¤ë¦„ì°¨ìˆœ
    operations-sorter: alpha
    tags-sorter: alpha
    path: /swagger-ui
    #swagger-ui default urlì¸ petstore html ë¬¸ì„œ ë¹„í™œì„±í™” ì—¬ë¶€
    disable-swagger-default-url: true
    display-request-duration: true  # try it out ì„ í–ˆì„ ë•Œ request duration ì„ ì¶”ê°€ë¡œ ì°ì–´ì¤Œ
  #OpenAPI 3 ë¡œ ë¬¸ì„œí™”í•  api path ë¦¬ìŠ¤íŠ¸
  paths-to-match:
    - /v1/**
```

```java

@Component
public class SwaggerConfig {

	@Bean
	public OpenAPI openAPI(@Value("${springdoc.version}") String appVersion) {
		Info info = new Info()
			.title("Changsol Blog Search API")
			.version(appVersion)
			.description("ì°½ì†” ë¸”ë¡œê·¸ ê²€ìƒ‰ ì„œë¹„ìŠ¤ì— ì˜¤ì‹ ê±¸ í™˜ì˜í•©ë‹ˆë‹¤.ğŸ˜")
			.contact(new Contact().name("changsol-github").url("https://github.com/ChangSol"))
			.license(new License().name("Apache License Version 2.0")
								  .url("http://www.apache.org/licenses/LICENSE-2.0"));

		return new OpenAPI()
			.components(new Components())
			.info(info);
	}
}
```
- module-external ì™¸ë¶€ KEY í•„ìš” (module-external yml ì°¸ê³ )
```yaml
kakao:
  host: https://dapi.kakao.com
  blog-search-end-point: /v2/search/blog
  rest-api-key: #Kakao REST_API_KEY INPUT

naver:
  host: https://openapi.naver.com
  blog-search-end-point: /v1/search/blog.json
  client-id: #Naver CLIENT_ID INPUT
  client-secret: #Naver CLIENT_SECRET INPUT
```

### 2) ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬
- module 
  - lombok:1.18.2 => ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ ì²˜ë¦¬.
  - mapstruct:1.5.2.Final => Classê°„ ë³€í™˜ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ë§¤í¼ í´ë˜ìŠ¤. DTO->Entity, Entity->DTO, DTO->DTO ë“±
  - guava:31.1-jre => Google Core ë¼ì´ë¸ŒëŸ¬ë¦¬. ì£¼ë¡œ collection ì´ˆê¸°í™”ì— ì‚¬ìš©í•˜ì˜€ìŒ
  - commons-lang3:3.12.0 => Lang ìœ í‹¸ë¦¬í‹°ë¡œ ì‚¬ìš©.
  - commons-collections4:4.4 => Colletion ìœ í‹¸ë¦¬í‹°ë¡œ ì‚¬ìš©.
  - commons-io:2.7 => Apache IO ë¼ì´ë¸ŒëŸ¬ë¦¬. DataReader ë“± ì½ê¸°ì— ì‚¬ìš©í•˜ì˜€ìŒ
- module-search
  - springdoc-openapi-ui:1.6.14 => API Docsë¥¼ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬. Swagger ì‘ì„± 

### 3) ëª¨ë“ˆ êµ¬ì¡°

- module-core : ë„ë©”ì¸ ëª¨ë“ˆ
- module-external : ì™¸ë¶€ API í†µì‹  ëª¨ë“ˆ
- module-search : ë¸”ë¡œê·¸ ê²€ìƒ‰ ëª¨ë“ˆ

### 4) Domain Model

- ê²€ìƒ‰ì–´ ê´€ë¦¬ í…Œì´ë¸”
```h2
create table blog_search_keyword
(
    keyword    varchar(255)     not null, -- ê²€ìƒ‰ì–´
    created_at timestamp,                 -- ìƒì„±ì‹œê°„
    updated_at timestamp,                 -- ìˆ˜ì •ì‹œê°„
    count      bigint default 0 not null, -- ê²€ìƒ‰ íšŸìˆ˜
    version    integer,                   -- optimistic rock version
    primary key (keyword)
)
```
- ì˜¤ë¥˜ ë¡œê·¸ ê´€ë¦¬ í…Œì´ë¸”
```h2
create table error_log (
       id bigint generated by default as identity, -- ì¼ë ¨ë²ˆí˜¸
        created_at timestamp, -- ìƒì„±ì‹œê°„
        updated_at timestamp, -- ìˆ˜ì •ì‹œê°„
        data clob, -- ìš”ì²­ ë°ì´í„°
        error_class varchar(255), -- ì˜¤ë¥˜ í´ë˜ìŠ¤ëª…
        error_message clob, -- ì˜¤ë¥˜ ë©”ì‹œì§€
        method varchar(255), -- ì˜¤ë¥˜ API Method
        origin clob, -- origin url
        query clob, -- ìš”ì²­ query
        remote_addr varchar(255), -- ìš”ì²­ IP
        request_uri clob, -- ìš”ì²­ uri
        status varchar(255), -- ì˜¤ë¥˜ ìƒíƒœ
        status_code integer, -- ì˜¤ë¥˜ ìƒíƒœ ì½”ë“œ
        user_agent varchar(255), -- ìš”ì²­ ê¸°ê¸° ì •ë³´
        primary key (id)
    )
```

## 3. ì‘ë‹µ ë° ì˜¤ë¥˜

- ì½”ë“œ ì •ì˜

<table>
  <tr>
    <td>ì½”ë“œ</td>
    <td>ì„¤ëª…</td>
  </tr>
  <tr>
    <td>200</td>
    <td>ì„±ê³µ</td>
  </tr>
  <tr>
    <td>500</td>
    <td>Server Error</td>
  </tr>
  <tr>
    <td>400</td>
    <td>ì˜ëª»ëœ ìš”ì²­</td>
  </tr>
  <tr>
    <td>404</td>
    <td>ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ</td>
  </tr>
  <tr>
    <td>409</td>
    <td>ë°ì´í„°ì— ëŒ€í•œ ì¶©ëŒ</td>
  </tr>
</table>

- ì˜¤ë¥˜ ì½”ë“œ ìƒì„¸

<table>
  <tr>
    <td>í´ë˜ìŠ¤</td>
    <td>ì½”ë“œ</td>
    <td>ì„¤ëª…</td>
    <td>ì˜ˆì‹œ</td>
  </tr>

  <tr>
    <td>ê°ì¢…í´ë˜ìŠ¤</td>
    <td>500</td>
    <td>ê°ì¢… ì˜¤ë¥˜ í´ë˜ìŠ¤ì— ëŒ€í•œ ì²˜ë¦¬</td>
    <td>

  ```json
  {
    "timestamp": "2023-03-21 14:03:50.156",
    "status": "INTERNAL_SERVER_ERROR",
    "statusCode": 500,
    "errorClass": "org.springframework.web.server.ServerErrorException",
    "errorMessage": "500 INTERNAL_SERVER_ERROR \"500 error test\"",
    "fieldErrors": []
  }
  ```

  </td>
  </tr>

  <tr>
    <td>WebClientException</td>
    <td>502</td>
    <td>WebClient í†µì‹  ì˜¤ë¥˜ 4xx ë°œìƒ ì‹œ</td>
    <td>

  ```json
  {
    "timestamp": "2023-03-21 21:25:29.238",
    "status": "BAD_GATEWAY",
    "statusCode": 502,
    "errorClass": "org.changsol.exceptions.WebClientException",
    "errorMessage": "{\"errorType\":\"AccessDeniedError\",\"message\":\"appKey(9b52e53084225d4c6983c1f4e245794f) is already deactivated\"}",
    "requestUri": "/v1/blogs",
    "fieldErrors": []
  }
  ```

  </td>
  </tr>

  <tr>
    <td>BadRequestException</td>
    <td>400</td>
    <td>ì˜ëª»ëœ ìš”ì²­</td>
    <td>

  ```json
  {
    "timestamp": "2023-03-21 21:16:46.637",
    "status": "BAD_REQUEST",
    "statusCode": 400,
    "errorClass": "org.changsol.exceptions.BadRequestException",
    "errorMessage": "ìš”ì²­í•˜ì‹  í˜ì´ì§€ì˜ ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
    "requestUri": "/v1/blogs",
    "fieldErrors": []
  }
  ```
  </td>
  </tr>

  <tr>
    <td>BindException</td>
    <td>400</td>
    <td>ìš”ì²­ ë°ì´í„°ì— ëŒ€í•œ ìœ íš¨ì„± ê²€ì¦ ì˜¤ë¥˜</td>
    <td>

  ```json
  {
    "timestamp": "2023-03-21 04:07:25.276",
    "status": "BAD_REQUEST",
    "statusCode": 400,
    "errorClass": "org.springframework.validation.BindException",
    "errorMessage": "Binding Error",
    "fieldErrors": [
      {
        "fieldName": "keyword",
        "errorMessage": "ê²€ìƒ‰ í‚¤ì›Œë“œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."
      },
      {
        "fieldName": "blogSortType",
        "errorMessage": "ì •ë ¬ ë°©ì‹ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."
      }
    ]
  }
  ```
  </td>
  </tr>

  <tr>
    <td>NotFoundException</td>
    <td>404</td>
    <td>ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì§€ ëª»í•˜ëŠ” ì˜¤ë¥˜</td>
    <td>

  ```json
  {
    "timestamp": "2023-03-21 04:07:25.276",
    "status": "BAD_REQUEST",
    "statusCode": 400,
    "errorClass": "org.springframework.validation.BindException",
    "errorMessage": "Binding Error",
    "fieldErrors": [
      {
        "fieldName": "keyword",
        "errorMessage": "ê²€ìƒ‰ í‚¤ì›Œë“œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."
      },
      {
        "fieldName": "blogSortType",
        "errorMessage": "ì •ë ¬ ë°©ì‹ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."
      }
    ]
  }
  ```

  </td>
  </tr>

  <tr>
    <td>DataIntegrityViolationException</td>
    <td>409</td>
    <td>ë°ì´í„°ì— ëŒ€í•œ ì¶©ëŒ ë°œìƒ</td>
    <td>

  ```json
  {
    "timestamp": "2023-04-02 17:18:43.965",
    "status": "CONFLICT",
    "statusCode": 409,
    "errorClass": "org.springframework.dao.DataIntegrityViolationException",
    "errorMessage": "could not execute statement; SQL [n/a]; constraint [\"PUBLIC.UK_T6GQ849H0617PY99WS528RLDV_INDEX_8 ON PUBLIC.BLOG_SEARCH_KEYWORD(KEYWORD2) VALUES 1\"; SQL statement:\ninsert into blog_search_keyword (created_at, updated_at, count, keyword2, version, keyword) values (?, ?, ?, ?, ?, ?) [23505-200]]; nested exception is org.hibernate.exception.ConstraintViolationException: could not execute statement",
    "requestUri": "/v1/blogs",
    "fieldErrors": []
  }
  ```

  </td>
  </tr>
</table>

## 4. í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤
<p align="left">
<img src="readme_resource/test_case.jpg" height="200px" width="300px">
</p>

## 5. ì‹¤í–‰ ë° API Docs
### 1) ì‹¤í–‰ ë°©ë²•
- [Executable JAR ë‹¤ìš´ë¡œë“œ](https://github.com/ChangSol/blog-search-server/raw/main/executable_jar/blog-search-server-0.0.1-SNAPSHOT.jar)
- ì‹¤í–‰ ëª…ë ¹ì–´ (ê¸°ë³¸ 8080 port)

```
java -jar blog-search-server-0.0.1-SNAPSHOT.jar
```

- ì‹¤í–‰ ëª…ë ¹ì–´ (ë‹¤ë¥¸ port ì‚¬ìš© ì‹œ)

```
java -jar "-Dserver.port=ì‚¬ìš©í• í¬íŠ¸" blog-search-server-0.0.1-SNAPSHOT.jar
```
### 2) API Document
- API Docs url : http://localhost:8080/swagger-ui

### 3) H2 DB
- consol url : http://localhost:8080/h2
- ê³„ì • : [H2 DB ê´€ë ¨ ë‚´ìš© ì°¸ê³ ](#2-environment)
<p align="left">
<img src="readme_resource/h2.png" height="300px" width="400px">
</p>
